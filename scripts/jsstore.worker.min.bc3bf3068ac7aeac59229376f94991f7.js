/*! For license information please see jsstore.worker.min.bc3bf3068ac7aeac59229376f94991f7.js.LICENSE.txt */
var JsStoreWorker=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}({2:function(e,t,n){"use strict";n.r(t),n.d(t,"QueryManager",(function(){return ze}));var r,o,u,i,a,s,c,l,h,f=function(e){return Promise.resolve(e)},p=function(e){return new Promise(e)};!function(e){e.InvalidUpdateColumn="invalid_update_column",e.UndefinedColumn="undefined_column",e.UndefinedValue="undefined_value",e.UndefinedColumnName="undefined_column_name",e.UndefinedDbName="undefined_database_name",e.UndefinedColumnValue="undefined_column_value",e.NotArray="not_array",e.NoValueSupplied="no_value_supplied",e.ColumnNotExist="column_not_exist",e.EnableSearchOff="enable_search_off",e.InvalidOp="invalid_operator",e.NullValue="null_value",e.WrongDataType="wrong_data_type",e.TableNotExist="table_not_exist",e.DbNotExist="db_not_exist",e.ConnectionAborted="connection_aborted",e.ConnectionClosed="connection_closed",e.NotObject="not_object",e.InvalidConfig="invalid_config",e.DbBlocked="Db_blocked",e.IndexedDbNotSupported="indexeddb_not_supported",e.NullValueInWhere="null_value_in_where",e.InvalidJoinQuery="invalid_join_query",e.InvalidOrderQuery="invalid_order_query",e.InvalidQuery="invalid_query",e.InvalidGroupQuery="invalid_group_query",e.ImportScriptsFailed="import_scripts_failed",e.MethodNotExist="method_not_exist",e.Unknown="unknown",e.InvalidMiddleware="invalid_middleware"}(r||(r={})),function(e){e.Registered="registerd",e.Failed="failed",e.NotStarted="not_started"}(o||(o={})),function(e){e.String="string",e.Object="object",e.Array="array",e.Number="number",e.Boolean="boolean",e.Null="null",e.DateTime="date_time"}(u||(u={})),function(e){e.InitDb="init_db",e.Get="get",e.Set="set",e.Select="select",e.Insert="insert",e.Update="update",e.Remove="remove",e.OpenDb="open_db",e.Clear="clear",e.DropDb="drop_db",e.Count="count",e.ChangeLogStatus="change_log_status",e.Terminate="terminate",e.Transaction="transaction",e.CloseDb="close_db",e.Union="union",e.Intersect="intersect",e.ImportScripts="import_scripts",e.Middleware="middleware"}(i||(i={})),function(e){e.RequestQueueEmpty="requestQueueEmpty",e.RequestQueueFilled="requestQueueFilled",e.Upgrade="upgrade",e.Create="create",e.Open="open"}(a||(a={})),function(e){e.Where="where",e.Like="like",e.Regex="regex",e.In="in",e.Equal="=",e.Between="-",e.GreaterThan=">",e.LessThan="<",e.GreaterThanEqualTo=">=",e.LessThanEqualTo="<=",e.NotEqualTo="!=",e.Aggregate="aggregate",e.Max="max",e.Min="min",e.Avg="avg",e.Count="count",e.Sum="sum",e.Or="or",e.Skip="skip",e.Limit="limit",e.And="and",e.IgnoreCase="ignoreCase",e.Then="then"}(s||(s={})),function(e){e.ReadOnly="readonly",e.ReadWrite="readwrite"}(c||(c={})),function(e){e.First="f",e.Last="l",e.Any="a"}(l||(l={})),function(e){e.Connected="connected",e.Closed="closed",e.NotStarted="not_started",e.UnableToStart="unable_to_start",e.ClosedByJsStore="closed_by_jsstore"}(h||(h={}));var d,y=function(){function e(e){this.columns=[],this.autoIncColumnValue={},this.columns=this.setColumn(e.columns),this.name=e.name,this.alter=e.alter||{}}return e.prototype.setColumn=function(e){var t=[],n=function(n){var o=e[n];o.name=n,o.autoIncrement&&(r.autoIncColumnValue[n]=0),o.primaryKey&&(r.primaryKey=n),o.enableSearch=null==o.enableSearch||o.enableSearch;var u=r.columns.indexOf((function(e){return e.name===n}));if(u<0)t.push(o);else{var i=r.columns[u];Object.assign(i,o)}},r=this;for(var o in e)n(o);return t},e}(),v=function(){function e(){}return e.autoIncrementKey=function(e,t){return"JsStore_"+e+"_"+t+"_Value"},e.set=function(t,n,r){r.tx||r.createTransaction([e.tableName]);var o=r.objectStore(e.tableName);return p((function(e,r){var u=o.put({key:t,value:n});u.onsuccess=function(){e()},u.onerror=r}))},e.get=function(t,n){n.tx||n.createTransaction([e.tableName]);var r=n.objectStore(e.tableName);return p((function(e,o){var u=r.get(n.keyRange(t));u.onsuccess=function(){var t=u.result;e(t&&t.value)},u.onerror=o}))},e.remove=function(t,n){n.tx||n.createTransaction([e.tableName]);var r=n.objectStore(e.tableName);return p((function(e,o){var u=r.delete(n.keyRange(t));u.onsuccess=e,u.onerror=o}))},e.tableName="JsStore_Meta",e.dbSchema="JsStore_DbSchema",e}(),m=function(e){this.name=e.name,this.version=e.version||1,e.tables.push({name:v.tableName,columns:{key:{primaryKey:!0},value:{enableSearch:!1}}}),this.tables=e.tables.map((function(e){return new y(e)}))},b=function(e,t){for(var n in e)t(n,e[n])},g=function(){function e(e,t){this.type=e,this.info_=t,this.message=this.getMsg_()}return e.prototype.log=function(e){this.status&&console.log(e)},e.prototype.throw=function(){throw this.get()},e.prototype.logError=function(){console.error(this.get())},e.prototype.get=function(){return{message:this.message,type:this.type}},e.prototype.getMsg_=function(){var e;switch(this.type){case r.NotArray:e="Supplied value is not an array";break;case r.UndefinedColumn:e="Column is undefined in Where";break;case r.UndefinedValue:e="Value is undefined in Where";break;case r.UndefinedColumnName:e="Column name is undefined '"+this.info_.TableName+"'";break;case r.UndefinedDbName:e="Database name is not supplied";break;case r.UndefinedColumnValue:e="Column value is undefined";break;case r.NoValueSupplied:e="No value is supplied";break;case r.InvalidOp:e="Invalid Op Value '"+this.info_.Op+"'";break;case r.ColumnNotExist:e=this.info_.isOrder?"Column '"+this.info_.column+"' in order query does not exist":"Column '"+this.info_.column+"' does not exist";break;case r.EnableSearchOff:e="Search is turned off for the Column '"+this.info_.column+"'";break;case r.NullValue:e="Null value is not allowed for column '"+this.info_.ColumnName+"'";break;case r.WrongDataType:e="Supplied value for column '"+this.info_.column+"' have wrong data type";break;case r.TableNotExist:e="Table '"+this.info_.tableName+"' does not exist";break;case r.DbNotExist:e="Database with name "+this.info_.dbName+" does not exist";break;case r.NotObject:e="supplied value is not object";break;case r.InvalidOp:e="Invalid Config '"+this.info_.Config+" '";break;case r.DbBlocked:e="database is blocked, cant be deleted right now";break;case r.NullValueInWhere:e="Null/undefined is not allowed in where. Column '"+this.info_.column+"' has null";break;case r.MethodNotExist:e="method '"+this.info_+"' does not exist.";break;case r.IndexedDbNotSupported:e="Browser does not support indexeddb";break;case r.InvalidJoinQuery:case r.InvalidGroupQuery:case r.InvalidOrderQuery:case r.ImportScriptsFailed:e=this.info_;break;case r.InvalidMiddleware:e="No function "+this.info_+" is found.";break;default:this.type||(this.type=r.Unknown),e=this.message}return e},e}(),_=function(){function e(){this.logger=new g(null)}return e.prototype.emptyTx=function(){this.tx&&(this.tx.oncomplete=null,this.tx.onabort=null,this.tx.onerror=null,this.tx=null)},e.prototype.createTransactionIfNotExist=function(e,t){this.tx||this.createTransaction(e,t)},e.prototype.createTransaction=function(e,t){var n=this;return void 0===t&&(t=c.ReadWrite),this.tx=this.con.transaction(e,t),p((function(e,t){n.tx.oncomplete=e,n.tx.onabort=e,n.tx.onerror=t}))},e.prototype.keyRange=function(e,t){var n;switch(t){case s.Between:n=IDBKeyRange.bound(e.low,e.high,!1,!1);break;case s.GreaterThan:n=IDBKeyRange.lowerBound(e,!0);break;case s.GreaterThanEqualTo:n=IDBKeyRange.lowerBound(e);break;case s.LessThan:n=IDBKeyRange.upperBound(e,!0);break;case s.LessThanEqualTo:n=IDBKeyRange.upperBound(e);break;default:n=IDBKeyRange.only(e)}return n},e.prototype.objectStore=function(e){return this.tx.objectStore(e)},e.prototype.abortTransaction=function(){this.tx&&this.tx.abort()},e.prototype.close=function(){var e=this;return this.con&&this.con.close(),p((function(t){e.con=null,setTimeout(t,100)}))},e.prototype.initDb=function(e){var t,n=this,r=!1,o=e.version;return p((function(u,i){var a=indexedDB.open(e.name,o);a.onsuccess=function(){n.con=a.result,n.con.onversionchange=function(e){e.target.close()},u({isCreated:r,oldVersion:t,newVersion:o})},a.onerror=function(e){console.error("error",e),i(e)},a.onupgradeneeded=function(n){t=n.oldVersion;var u=n.target,i=u.result;r=!0;var a=u.transaction,s=i.objectStoreNames,c=function(e,t){var n=t.name;if(t.enableSearch&&!e.indexNames.contains(n)){var r=t.primaryKey?{unique:!0}:{unique:t.unique};r.multiEntry=t.multiEntry;var o=null==t.keyPath?n:t.keyPath;e.createIndex(n,o,r)}},l=function(e,t,n){var r=t.columns.findIndex((function(e){return e.name===n}));r>=0&&(t.columns.splice(r,1),e.deleteIndex(n))};e.tables.forEach((function(e){if(!s.contains(e.name))return function(e){var t=e.primaryKey?{keyPath:e.primaryKey}:{autoIncrement:!0},n=i.createObjectStore(e.name,t);e.columns.forEach((function(e){c(n,e)}))}(e);for(var n=a.objectStore(e.name),r=t+1;r<=o;r++){var u=e.alter[r];u&&(u.add&&e.setColumn(u.add).forEach((function(t){c(n,t),e.columns.push(t)})),b(u.drop||{},(function(t){l(n,e,t)})),b(u.modify||{},(function(t,r){var o=r.multiEntry||r.keyPath||r.unique,u=e.columns.find((function(e){return e.name===t})),i=Object.assign(u,r);i.name=t,o&&(l(n,e,t),c(n,i),e.columns.push(i))})))}}));for(var h=function(t,n){var r=s.item(t);e.tables.findIndex((function(e){return e.name===r}))<0&&i.deleteObjectStore(r)},f=0,p=s.length;f<p;f++)h(f)}}))},e}(),w=function(e){return Promise.all(e)},x=function(e){return Promise.reject(e)},k=function(e){if(e instanceof g)return e.logError(),e.get();var t=void 0;return e.name?(t=new g(e.name)).message=e.message:(t=new g(e.target.error.name)).message=e.target.error.message,t.get()},E=function(){function e(){this.rowAffected=0,this.isTxQuery=!1,this.results=[]}return Object.defineProperty(e.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),e.prototype.table=function(e){var t=e||this.tableName;return this.db.tables.find((function(e){return e.name===t}))},e.prototype.primaryKey=function(e){return this.table(e).primaryKey},e.prototype.getColumnInfo=function(e,t){return this.table(t).columns.find((function(t){return t.name===e}))},e.prototype.onException=function(e,t){return console.error(e),this.util.abortTransaction(),x(function(e,t){return void 0===t&&(t=r.InvalidQuery),e.name=t,k(e)}(e,t))},e}(),T=function(e){if(null==e)return u.Null;var t=typeof e;if("object"===t){if(Array.isArray(e))return u.Array;if(e instanceof Date)return u.DateTime}return t},S=function(e){return null==e||"number"===typeof e&&isNaN(e)},q=function(){function e(e,t){this.table=e,this.autoIncrementValue=t}return e.prototype.checkAndModifyValues=function(e){var t,n=this;this.query=e;var r=e.values,o=[];return r.every((function(r,u){return t=n.checkAndModifyValue(r),e.ignore&&t&&(o.push(u),t=null),!t})),o.forEach((function(e){r.splice(e,1)})),{err:t,values:r}},e.prototype.checkAndModifyValue=function(e){var t,n=this;return this.table.columns.every((function(r){return!(t=n.checkAndModifyColumnValue_(r,e))})),t},e.prototype.checkNotNullAndDataType_=function(e,t){return e.notNull&&S(t[e.name])?this.getError(r.NullValue,{ColumnName:e.name}):e.dataType&&!S(t[e.name])&&T(t[e.name])!==e.dataType?this.getError(r.WrongDataType,{column:e.name}):void 0},e.prototype.checkAndModifyColumnValue_=function(e,t){var n=t[e.name];if(e.autoIncrement?S(n)?t[e.name]=++this.autoIncrementValue[e.name]:T(n)===u.Number&&n>this.autoIncrementValue[e.name]&&(this.autoIncrementValue[e.name]=n):void 0!==e.default&&S(n)&&(t[e.name]=e.default),this.query.validation)return this.checkNotNullAndDataType_(e,t)},e.prototype.getError=function(e,t){return new g(e,t)},e}(),C=function(){function e(e){this.table=e}return e.prototype.check=function(e,t){var n,o=this;return typeof e===u.Object?this.table?this.table.columns.every((function(t){return t.name in e&&(n=o.checkByColumn_(t,e[t.name])),!n})):n=new g(r.TableNotExist,{tableName:t}):n=new g(r.NotObject),n},e.prototype.checkByColumn_=function(e,t){if(!0===e.notNull&&S(t))return new g(r.NullValue,{ColumnName:e.name});var n=T(t),o=null!=t;if(e.dataType&&o&&n!==e.dataType&&"object"!==n)return new g(r.WrongDataType,{column:e.name});if(o&&"object"===n){var u=["+","-","*","/","{push}"];for(var i in t)if(u.indexOf(i)<0&&e.dataType&&n!==e.dataType)return new g(r.WrongDataType,{column:e.name})}},e}(),O=function(){function e(e){this.db=e}return e.prototype.validate=function(e,t){switch(e){case i.Select:case i.Remove:case i.Count:return this.checkSelect(t);case i.Insert:return this.checkInsertQuery(t);case i.Update:return this.checkUpdate(t)}},e.prototype.getTable_=function(e){return this.db.tables.find((function(t){return t.name===e}))},e.prototype.isInsertQryValid=function(e){var t,n=this.getTable_(e.into);if(n)switch(T(e.values)){case u.Array:break;case u.Null:t=new g(r.NoValueSupplied);break;default:t=new g(r.NotArray)}else t=new g(r.TableNotExist,{tableName:e.into});return{table:n,log:t}},e.prototype.checkUpdate=function(e){var t=new C(this.getTable_(e.in)).check(e.set,e.in);if(t)return t;if(null!=e.where){if(t=this.checkForNullInWhere_(e))return t;this.addGreatAndLessToNotOp_(e)}},e.prototype.checkSelect=function(e){if(!this.getTable_(e.from))return new g(r.TableNotExist,{tableName:e.from});if(e.where){var t=this.checkForNullInWhere_(e);if(t)return t;this.addGreatAndLessToNotOp_(e)}},e.prototype.checkForNullInWhere_=function(e){for(var t in e.where)if(null==e.where[t])return new g(r.NullValueInWhere,{column:t})},e.prototype.addGreatAndLessToNotOp_=function(e){var t=e.where,n=function(e,t){return t.findIndex((function(t){return null!=e[t][s.NotEqualTo]}))>=0},r=function(e,t){var n;return t.forEach((function(t){null!=(n=e[t])[s.NotEqualTo]&&(e[t][s.GreaterThan]=n[s.NotEqualTo],void 0===e[s.Or]?(e[s.Or]={},e[s.Or][t]={}):void 0===e[s.Or][t]&&(e[s.Or][t]={}),e[s.Or][t][s.LessThan]=n[s.NotEqualTo],delete e[t][s.NotEqualTo])})),e};if(T(t)===u.Object){var o=Object.keys(t);if(n(t,o))if(1===o.length)e.where=r(t,o);else{var i=[];o.forEach((function(e){var n;i.push(r(((n={})[e]=t[e],n),[e]))})),e.where=i}}else{var a=[];t.forEach((function(e){var t=Object.keys(e);n(e,t)&&(e=r(e,t)),a.push(e)})),e.where=a}},e.prototype.checkInsertQuery=function(e){var t=this.isInsertQryValid(e),n=t.table,r=t.log;if(r)return r;if(!e.skipDataCheck){var o=new q(n,n.autoIncColumnValue).checkAndModifyValues(e),u=o.values,i=o.err;return e.values=u,i}},e}(),I=(d=function(e,t){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),j=function(e){function t(t,n){var r=e.call(this)||this;return r.valuesAffected_=[],null==t.validation&&(t.validation=!0),r.query=t,r.util=n,r.tableName=t.into,r}return I(t,e),t.prototype.execute=function(e){var t=this,n=this.db,r=new O(n).validate(i.Insert,this.query);return r?x(r):e().then((function(e){return t.insertData_(n).then((function(e){return t.query.return?t.valuesAffected_:t.rowAffected}))})).catch((function(e){return t.util.abortTransaction(),x(e)}))},t.prototype.insertData_=function(e){var t,n,r,o=this,u=this.query;return t=u.return?function(e){o.valuesAffected_.push(e)}:function(e){++o.rowAffected},r=u.upsert?"put":"add",n=u.ignore&&!o.isTxQuery?function(e){return o.util.con.transaction(u.into,c.ReadWrite).objectStore(u.into)[r](e)}:(o.isTxQuery||o.util.createTransaction([u.into,v.tableName]),o.objectStore=o.util.objectStore(o.tableName),function(e){return o.objectStore[r](e)}),w(u.values.map((function(e){return p((function(r,o){var i=n(e);i.onerror=function(e){u.ignore?r():o(e)},i.onsuccess=function(){t(e),r()}}))}))).then((function(){v.set(v.dbSchema,e,o.util)}))},t}(E),A=void 0===self.alert&&"undefined"==typeof ServiceWorkerGlobalScope,N=function(){try{if(indexedDB||(indexedDB=self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB),!indexedDB)return!1;IDBTransaction=IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction,self.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange}catch(e){return!1}return!0}(),R=function(e){return Object.keys(e)},Q=function(e){return Array.isArray(e)},L=function(e){return R(e).length},D=function(e){for(var t in e)return t},V=function(){function e(){}return e.prototype.setCaseAndValue=function(e,t){this.caseQuery_=e,this.setValue(t)},e.prototype.setCaseAndColumn=function(e,t){return this.caseQuery_=e,this.setColumn(t),this},e.prototype.setColumn=function(e){return this.columnName_=e,this.caseColumnQuery_=this.caseQuery_[this.columnName_],this.length_=this.caseColumnQuery_.length,this},e.prototype.setValue=function(e){return this.value=e,this},e.prototype.evaluate=function(){for(var e=0;e<this.length_;e++)if(!0===this.checkCase_(this.caseColumnQuery_[e]))return this.caseColumnQuery_[e].then;var t=this.caseColumnQuery_[this.length_-1].then;return null==t?this.value[this.columnName_]:t},e.prototype.checkCase_=function(e){var t;for(t in e){switch(t){case s.GreaterThan:if(this.value[this.columnName_]>e[t])return!0;break;case s.Equal:if(this.value[this.columnName_]===e[t])return!0;break;case s.LessThan:if(this.value[this.columnName_]<e[t])return!0;break;case s.GreaterThanEqualTo:if(this.value[this.columnName_]>=e[t])return!0;break;case s.LessThanEqualTo:if(this.value[this.columnName_]<=e[t])return!0;break;case s.NotEqualTo:if(this.value[this.columnName_]!==e[t])return!0;break;case s.Between:if(this.value[this.columnName_]>e[t].low&&this.value[this.columnName_]<e[t].high)return!0}return!1}},e}(),W=function(e){var t,n=this,r=!1;return function(o){(t=o.target.result)?r&&n.results.length!==n.limitRecord?(n.pushResult(t.value),t.continue()):(r=!0,t.advance(n.skipRecord)):e()}},B=function(e){var t,n=this,r=!1;return function(o){(t=o.target.result)?r?(n.pushResult(t.value),t.continue()):(r=!0,t.advance(n.skipRecord)):e()}},P=function(e){var t,n=this;return function(r){(t=r.target.result)?(n.pushResult(t.value),t.continue()):e()}},M=function(e){var t,n=this;return function(r){(t=r.target.result)&&n.results.length!==n.limitRecord?(n.pushResult(t.value),t.continue()):e()}},U=function(e){return e.replace(/\s/g,"")},G=function(e){var t;if(null==this.query.join)t=this.getColumnInfo(e);else{var n=U(e).split(".");e=n[1],t=this.getColumnInfo(e,n[0])}if(null==t){var o=this.results[0][e];if(o)return{dataType:T(o),name:e};throw new g(r.ColumnNotExist,{column:e,isOrder:!0})}return t},F=function(e,t){return t.localeCompare(e)},K=function(e,t){return e.localeCompare(t)},J=function(e,t){return new String(t).localeCompare(e)},z=function(e,t){return new String(e).localeCompare(t)},$=function(e,t){return t-e},H=function(e,t){return e-t},X=function(e,t){return t.getTime()-e.getTime()},Y=function(e,t){return e.getTime()-t.getTime()},Z=function(e,t,n){for(var r in n){this.thenEvaluator.setCaseAndValue(n,e);var o=this.thenEvaluator.setColumn(r).evaluate();this.thenEvaluator.setCaseAndValue(n,t);var i=this.thenEvaluator.setColumn(r).evaluate();return typeof e[o]===u.String?F(e[o],t[i]):$(e[o],t[i])}},ee=function(e,t,n){for(var r in n){this.thenEvaluator.setCaseAndValue(n,e);var o=this.thenEvaluator.setColumn(r).evaluate();this.thenEvaluator.setCaseAndValue(n,t);var i=this.thenEvaluator.setColumn(r).evaluate();return typeof e[o]===u.String?K(e[o],t[i]):H(e[o],t[i])}},te=function(e,t){switch(e.dataType){case u.String:return"asc"===t.type?K:F;case u.Number:return"asc"===t.type?H:$;case u.DateTime:return"asc"===t.type?Y:X;default:return"asc"===t.type?z:J}},ne=function(e){var t,n=this;e.type=re(e.type);var r=e.by;if(null!=r&&typeof r===u.Object)"asc"===e.type?this.results.sort((function(e,t){return ee.call(n,e,t,r)})):this.results.sort((function(e,t){return Z.call(n,e,t,r)}));else{var o=G.call(this,r);if(null!=o){var i=te(o,e);r=o.name,null==e.case?this.results.sort((function(e,t){return i(e[r],t[r])})):(this.thenEvaluator.setCaseAndColumn(((t={})[r]=e.case,t),r),this.results.sort((function(e,t){return i(n.thenEvaluator.setValue(e).evaluate(),n.thenEvaluator.setValue(t).evaluate())})))}}},re=function(e){return null==e?"asc":e.toLowerCase()},oe=function(e){var t=this,n=!1;return function(r){var o=r.target.result;if(o)if(n&&t.results.length!==t.limitRecord){var u=o.value;t.shouldAddValue(u)&&t.pushResult(u),o.continue()}else n=!0,o.advance(t.skipRecord);else e()}},ue=function(e){var t=this,n=!1;return function(r){var o=r.target.result;if(o)if(n){var u=o.value;t.shouldAddValue(u)&&t.pushResult(u),o.continue()}else n=!0,o.advance(t.skipRecord);else e()}},ie=function(e){var t=this;return function(n){var r=n.target.result;if(r&&t.results.length!==t.limitRecord){var o=r.value;t.shouldAddValue(o)&&t.pushResult(o),r.continue()}else e()}},ae=function(e){var t=this;return function(n){var r=n.target.result;if(r){var o=r.value;t.shouldAddValue(o)&&t.pushResult(o),r.continue()}else e()}},se=function(e){var t,n,r=e.split("%");switch(r[1]?(t=r[1],n=r.length>2?l.Any:l.Last):(t=r[0],n=l.First),n){case l.First:return new RegExp("^"+t,"i");case l.Last:return new RegExp(t+"$","i");default:return new RegExp(""+t,"i")}},ce=function(e){return"object"===T(e)&&!(e instanceof RegExp)},le=function e(t){if(ce(t)){var n={};for(var r in t)n[r]=null!=t[r]&&ce(t[r])?e(t[r]):t[r];return n}return t},he=function(e,t,n){var r=T(e);if(r!==T(t))return!1;switch(r===u.DateTime&&(e=e.getTime(),t=t.getTime()),n){case s.GreaterThan:return e>t;case s.LessThan:return e<t;case s.LessThanEqualTo:return e<=t;case s.GreaterThanEqualTo:return e>=t;case s.NotEqualTo:return e!==t;default:return e===t}},fe=function(){function e(e,t){this.where=le(e),this.checkFlag=t}return e.prototype.remove=function(e){var t=e.pop();delete e.reduce((function(e,t){return e&&e[t]}),this.where)[t]},e.prototype.check=function(e){var t=!0;if(!this.checkFlag)return t;for(var n in this.where){if(!t)return t;var r=this.where[n],o=e[n];if("object"===T(r))for(var u in r){if(!t)return t;switch(u){case s.In:t=this.checkIn(n,o);break;case s.Like:t=this.checkLike_(n,o);break;case s.Regex:t=this.checkRegex(n,o);break;case s.Between:case s.GreaterThan:case s.LessThan:case s.GreaterThanEqualTo:case s.LessThanEqualTo:case s.NotEqualTo:t=this.checkComparisionOp_(n,o,u);break;default:t=!1}}else t=he(r,o)}return t},e.prototype.checkIn=function(e,t){return null!=this.where[e][s.In].find((function(e){return he(e,t)}))},e.prototype.checkLike_=function(e,t){return se(this.where[e][s.Like]).test(t)},e.prototype.checkRegex=function(e,t){return this.where[e][s.Regex].test(t)},e.prototype.checkComparisionOp_=function(e,t,n){var r=this.where[e][n];return n!=s.Between?he(t,r,n):he(t,r.low,">=")&&he(t,r.high,"<=")},e}(),pe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),de=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.shouldEvaluateLimitAtEnd=!1,t.shouldEvaluateSkipAtEnd=!1,t}return pe(t,e),t.prototype.goToWhereLogic=function(){var e=this.query,t=D(e.where);if(!this.objectStore.indexNames.contains(t)){var n=this.getColumnInfo(t),o=new g(null==n?r.ColumnNotExist:r.EnableSearchOff,{column:t});return x(o)}var u=e.where[t];if("object"!==T(u))return i=L(e.where)>1,this.whereCheckerInstance=new fe(e.where,i),this.whereCheckerInstance.remove([t]),this.executeWhereLogic(t,u,null,"next");var i=L(u)>1||L(e.where)>1;this.whereCheckerInstance=new fe(e.where,i);var a=D(u);switch(this.whereCheckerInstance.remove([t,a]),a){case s.Like:var c=se(u[s.Like]);return this.executeRegexLogic(t,c);case s.Regex:return this.executeRegexLogic(t,u[s.Regex]);case s.In:return this.executeInLogic(t,u[s.In]);case s.Between:case s.GreaterThan:case s.LessThan:case s.GreaterThanEqualTo:case s.LessThanEqualTo:return this.executeWhereLogic(t,u,a,"next");case s.Aggregate:break;default:return this.executeWhereLogic(t,u,null,"next")}},t}(E),ye=function(e,t){var n=this;return function(r){var o=r.target.result;if(n.results.length!==n.limitRecord&&o){var u=o.value;n.shouldAddValue(u)&&t(u),o.continue()}else e()}},ve=function(e,t){var n=this;return function(r){var o=r.target.result;if(o){var u=o.value;n.shouldAddValue(u)&&t(u),o.continue()}else e()}},me=function(e){var t=this;return function(n){var r=n.target.result;if(r&&t.results.length!==t.limitRecord){var o=r.value;t.shouldAddValue(o)&&t.pushResult(r.value),r.continue()}else e()}},be=function(e){var t=this;return function(n){var r=n.target.result;if(r){var o=r.value;t.shouldAddValue(o)&&t.pushResult(o),r.continue()}else e()}},ge=function(e,t){var n=this;return function(r){var o=r.target.result;n.results.length!==n.limitRecord&&o?(n.shouldAddValue(o)&&t(o.value),o.continue()):e()}},_e=function(e,t){var n=this;return function(r){var o=r.target.result;o?(n.shouldAddValue(o)&&t(o.value),o.continue()):e()}},we=function(e){var t=this;return function(n){var r=n.target.result;t.results.length!==t.limitRecord&&r?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):e()}},xe=function(e){var t=this;return function(n){var r=n.target.result;r?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):e()}},ke=function(){return(ke=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},Ee=function(){function e(e){this.joinQueryStack_=[],this.currentQueryStackIndex_=0,this.tablesFetched=[],this.results=[],this.select=e}return Object.defineProperty(e.prototype,"query",{get:function(){return this.select.query},enumerable:!1,configurable:!0}),e.prototype.getTable=function(e){return this.select.table(e)},e.prototype.executeSelect=function(e){return new Ce(e,this.select.util).execute()},e.prototype.execute=function(){var e=this,t=this.query;this.joinQueryStack_=T(t.join)===u.Object?[t.join]:t.join;for(var n=t.from,r=[n],o=0,i=this.joinQueryStack_.length;o<i;o++){var a=this.joinQueryStack_[o],s=this.getJoinTableInfo_(a.on);a.with===s.table1.table&&(s={table1:s.table2,table2:s.table1});var c=this.checkJoinQuery_(s,a);if(c)return x(c);this.joinQueryStack_[o].joinTableInfo=s,r.push(a.with)}return this.select.isTxQuery||this.select.util.createTransaction(r),this.executeSelect({from:n,where:t.where,case:t.case,flatten:t.flatten}).then((function(t){return e.results=t.map((function(t){var n;return(n={})[e.currentQueryStackIndex_]=t,n})),e.tablesFetched.push(n),e.startExecutingJoinLogic_()}))},e.prototype.onJoinQueryFinished_=function(){var e=this;if(this.results.length>0)try{var t=[],n=Object.keys(this.results[0]).length,o=function(e,t){if(null!=e.as)for(var n in e.as)void 0===t[e.as[n]]&&(t[e.as[n]]=t[n],delete t[n]);return t};this.results.forEach((function(r){for(var u=r[0],i=1;i<n;i++){var a=e.joinQueryStack_[i-1];u=ke(ke({},u),o(a,r[i]))}t.push(u)})),this.select.results=t,this.select.setLimitAndSkipEvaluationAtEnd_(),this.select.query.flatten=null,this.select.processOrderBy(),this.select.processGroupDistinctAggr()}catch(e){return x(new g(r.InvalidJoinQuery,e.message))}},e.prototype.startExecutingJoinLogic_=function(){var e=this,t=this.joinQueryStack_[this.currentQueryStackIndex_];if(!t)return this.onJoinQueryFinished_();try{var n=t.joinTableInfo;return this.executeSelect({from:t.with,where:t.where,case:t.case,flatten:t.flatten}).then((function(r){return e.jointables(t.type,n,r),e.tablesFetched.push(n.table2.table),++e.currentQueryStackIndex_,e.startExecutingJoinLogic_()}))}catch(e){return x(new g(r.InvalidJoinQuery,e.message))}},e.prototype.jointables=function(e,t,n){var r,o,u,i,a=this,s=[],c=t.table1.column,l=t.table2.column,h=this.tablesFetched.indexOf(t.table1.table),f=this.currentQueryStackIndex_+1;if("left"===e)u=0,i={},a.getTable(t.table2.table).columns.forEach((function(e){i[e.name]=null})),a.results.forEach((function(e){r=[],o=1===f?function(t){e[h][c]===t[l]&&r.push(t)}:function(t){var n=e[h];null!=n&&n[c]===t[l]&&r.push(t)},n.forEach(o),0===r.length&&(r=[i]),r.forEach((function(t){s[u]=ke({},e),s[u++][f]=t}))}));else!function(){var e=0;a.results.forEach((function(t){n.forEach((function(n){t[h][c]===n[l]&&(s[e]=ke({},t),s[e++][f]=n)}))}))}();this.results=s},e.prototype.getJoinTableInfo_=function(e){var t=(e=U(e)).split("="),n=t[0].split("."),r=t[1].split(".");return{table1:{table:n[0],column:n[1]},table2:{table:r[0],column:r[1]}}},e.prototype.checkJoinQuery_=function(e,t){var n,o=e.table1,u=e.table2,i=this.getTable(o.table),a=this.getTable(u.table);return t.with!==u.table&&(n=new g(r.InvalidJoinQuery,"on value should contains value of with")),null==i.columns.find((function(e){return e.name===o.column}))?n=new g(r.InvalidJoinQuery,"column "+o.column+" does not exist in table "+o.table):null==a.columns.find((function(e){return e.name===u.column}))&&(n=new g(r.InvalidJoinQuery,"column "+u.column+" does not exist in table "+u.table)),null==t.as&&(t.as={}),i.columns.every((function(e){var i=a.columns.find((function(t){return t.name===e.name&&t.name!==o.column}));return null==i||null!=t.as[i.name]||(n=new g(r.InvalidJoinQuery,"column "+e.name+" exist in both table "+o.table+" & "+u.table),!1)})),n},e}(),Te=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Se=function(){return(Se=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},qe=function(e,t){for(var n=0,r=t.length,o=e.length;n<r;n++,o++)e[o]=t[n];return e},Ce=function(e){function t(t,n){var r=e.call(this)||this;return r.sorted=!1,r.isSubQuery=!1,r.thenEvaluator=new V,r.returnResult_=function(){if(r.results.length>0){if(r.query.flatten){var e=[],t={};r.query.flatten.forEach((function(n){r.results.forEach((function(r,o){r[n].forEach((function(t){var o;e.push(Se(Se({},r),((o={})[n]=t,o)))})),t[o]=!0}))}));var n=0;R(t).forEach((function(e){r.results.splice(Number(e)-n,1),++n})),r.results=r.results.concat(e)}r.processGroupDistinctAggr(),r.processOrderBy(),r.shouldEvaluateSkipAtEnd&&r.results.splice(0,r.query.skip),r.shouldEvaluateLimitAtEnd&&(r.results=r.results.slice(0,r.query.limit))}return r.results},r.query=t,r.util=n,r.tableName=t.from,r.setPushResult(),Q(r.query.where)?(r.isArrayQry=!0,r.setLimitAndSkipEvaluationAtEnd_()):(r.skipRecord=t.skip,r.limitRecord=t.limit),t.order?((Q(t.order)||t.order.case||"object"==typeof t.order.by)&&(r.query.order.idbSorting=!1),r.setLimitAndSkipEvaluationAtEnd_()):t.groupBy&&r.setLimitAndSkipEvaluationAtEnd_(),r}return Te(t,e),t.prototype.execute=function(e){var t=this;e||(e=function(){return f(null)});try{var n=new O(this.db).validate(i.Select,this.query);return n?x(n):e().then((function(e){return t.initTransaction_(),(null==t.query.join?null!=t.query.where?Q(t.query.where)?t.processWhereArrayQry():t.processWhere_():t.executeWhereUndefinedLogic():t.executeJoinQuery()).then(t.returnResult_.bind(t))}))}catch(e){return this.onException(e)}},t.prototype.processWhereArrayQry=function(){var e=this;this.isArrayQry=!0;var t,n=this.query.where,r=this.primaryKey(),o=!0,u=[],i=function(){var i;if(t===s.And?!0===o?u=e.results:u.length>0&&(i=[],e.results.forEach((function(e){var t;t=e[r],u.findIndex((function(e){return e[r]===t}))>=0&&i.push(e)})),u=i,i=null):u.length>0?(e.results=qe(qe([],u),e.results),e.removeDuplicates(),u=e.results):u=e.results,o=!1,n.length>0)return e.results=[],a();e.results=u},a=function(){return e.query.where=n.shift(),e.query.where[s.Or]&&1===L(e.query.where)?(t=s.Or,e.query.where=e.query.where[s.Or]):t=s.And,e.processWhere_().then(i)};return a()},t.prototype.initTransaction_=function(){this.isTxQuery||this.util.createTransactionIfNotExist([this.tableName],c.ReadOnly),this.objectStore=this.util.objectStore(this.tableName)},t.prototype.processWhere_=function(){var e=this;return this.shouldAddValue=function(t){return e.whereCheckerInstance.check(t)},this.query.where.or&&this.processOrLogic_(),this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQueryFinish_=function(){this.isOr=!1,this.results=this.orInfo.results,this.orInfo=null,this.removeDuplicates()},t.prototype.orQuerySuccess_=function(){if(this.orInfo.results=qe(qe([],this.orInfo.results),this.results),!this.query.limit||this.query.limit>this.orInfo.results.length){this.results=[];var e=D(this.orInfo.orQuery);if(null!=e){var t={};return t[e]=this.orInfo.orQuery[e],delete this.orInfo.orQuery[e],this.query.where=t,this.goToWhereLogic().then(this.onWhereEvaluated.bind(this))}}return this.orQueryFinish_()},t.prototype.processOrLogic_=function(){this.isOr=!0;var e=this.query.where;this.orInfo={orQuery:e.or,results:[]},delete e.or},t}(de);Ce.prototype.executeInLogic=function(e,t){var n=this,r=this.skipRecord,o=function(e){0===r?n.pushResult(e):--r},u=function(){if(!1===n.shouldEvaluateLimitAtEnd&&!1===n.shouldEvaluateSkipAtEnd){if(n.skipRecord&&n.limitRecord)return ye;if(n.skipRecord)return ve;if(n.limitRecord)return me}return be}(),i=this.objectStore.index(e);return w(t.map((function(e){return t=e,p((function(e,r){var a=i.openCursor(n.util.keyRange(t));a.onsuccess=u.call(n,e,o),a.onerror=r}));var t})))},Ce.prototype.executeWhereUndefinedLogic=function(){var e,t=this;if(this.query.order&&!1!==this.query.order.idbSorting&&this.query.order.by){if(!this.objectStore.indexNames.contains(this.query.order.by))return x(new g(r.ColumnNotExist,{column:this.query.order.by,isOrder:!0}));var n=this.query.order.type&&"desc"===this.query.order.type.toLowerCase()?"prev":"next";this.sorted=!0,e=this.objectStore.index(this.query.order.by).openCursor(null,n)}else e=this.objectStore.openCursor();var o=function(){if(!1===t.shouldEvaluateLimitAtEnd&&!1===t.shouldEvaluateSkipAtEnd){if(t.skipRecord&&t.limitRecord)return W;if(t.skipRecord)return B;if(t.limitRecord)return M}return P}();return p((function(n,r){e.onerror=r,e.onsuccess=o.call(t,n)}))},Ce.prototype.executeWhereLogic=function(e,t,n,r){var o=this;t=n?t[n]:t;var u=this.objectStore.index(e).openCursor(this.util.keyRange(t,n),r),i=function(){if(!1===o.shouldEvaluateLimitAtEnd&&!1===o.shouldEvaluateSkipAtEnd){if(o.skipRecord&&o.limitRecord)return oe;if(o.skipRecord)return ue;if(o.limitRecord)return ie}return ae}();return p((function(e,t){u.onerror=t,u.onsuccess=i.call(o,e)}))},Ce.prototype.executeRegexLogic=function(e,t){var n=this,r=this.skipRecord,o=function(e){0===r?n.pushResult(e):--r};this.shouldAddValue=function(e){return t.test(e.key)&&n.whereCheckerInstance.check(e.value)};var u=this.objectStore.index(e).openCursor(),i=function(){if(!1===n.shouldEvaluateLimitAtEnd&&!1===n.shouldEvaluateSkipAtEnd){if(n.skipRecord&&n.limitRecord)return ge;if(n.skipRecord)return _e;if(n.limitRecord)return we}return xe}();return p((function(e,t){u.onerror=t,u.onsuccess=i.call(n,e,o)}))},Ce.prototype.setLimitAndSkipEvaluationAtEnd_=function(){this.query.limit&&(this.shouldEvaluateLimitAtEnd=!0),this.query.skip&&(this.shouldEvaluateSkipAtEnd=!0)},Ce.prototype.setPushResult=function(){var e=this;this.query.case?this.pushResult=function(t){var n;for(n in e.thenEvaluator.setCaseAndValue(e.query.case,t),e.query.case)t[n]=e.thenEvaluator.setColumn(n).evaluate();e.results.push(t)}:this.pushResult=function(t){e.results.push(t)}},Ce.prototype.removeDuplicates=function(){var e=this.results;this.results=null;for(var t=this.primaryKey(),n={},r=0,o=e.length;r<o;r++)n[e[r][t]]=e[r];for(var r in e=[],n)e.push(n[r]);this.results=e},Ce.prototype.executeJoinQuery=function(){return new Ee(this).execute()},Ce.prototype.processGroupDistinctAggr=function(){if(this.query.distinct){var e=[],t=this.results[0];for(var n in t)e.push(n);var r=this.primaryKey(),o=e.indexOf(r);e.splice(o,1),this.query.groupBy=e.length>0?e:null}this.query.groupBy?this.query.aggregate?this.executeAggregateGroupBy():this.processGroupBy():this.query.aggregate&&this.processAggregateQry()},Ce.prototype.processOrderBy=function(){var e=this.query.order;if(e&&this.results.length>0&&!this.sorted){var t=T(e);if(t===u.Object)ne.call(this,e);else if(t===u.Array){ne.call(this,e[0]);for(var n=function(t,n){var o=e[t-1].by,u=e[t],i=u.by,a=G.call(r,i);if(null!=a){i=a.name,u.type=re(u.type);var s=te(a,u);r.results.sort((function(e,t){return e[o]===t[o]?s(e[i],t[i]):0}))}},r=this,o=1,i=e.length;o<i;o++)n(o)}}},Ce.prototype.processAggregateQry=function(){var e,t=this.results,n=t.length,r={};this.results=void 0;var o=function(){var n=0;for(var r in t)n+=t[r][e]?1:0;return n},i=function(){var n=0;for(var r in t)n=n>t[r][e]?n:t[r][e];return n},a=function(){var n=1/0,r=1/0;for(var o in t)n=n<(r=t[o][e]?t[o][e]:1/0)?n:r;return n},s=function(){var n=0;for(var r in t)n+=t[r][e];return n},c=function(){var r=0;for(var o in t)r+=t[o][e];return r/n};for(var l in this.query.aggregate){var h=this.query.aggregate[l],f=T(h),p=void 0;switch(l){case"count":p=o;break;case"max":p=i;break;case"min":p=a;break;case"sum":p=s;break;case"avg":p=c}switch(f){case u.String:r[l+"("+(e=h)+")"]=p();break;case u.Array:for(var d in h)r[l+"("+(e=h[d])+")"]=p()}}for(var l in r)t[0][l]=r[l];this.results=[t[0]]},Ce.prototype.executeAggregateGroupBy=function(){var e=this.query.groupBy,t=this.results;this.results=void 0;var n,r,o,i,a={},c=this.query.aggregate,l=function(){var e=function(){return o=(o=a[r])?o["count("+i+")"]:0,o+=t[n][i]?1:0},l=function(){return o=(o=a[r])?o["max("+i+")"]:0,t[n][i]=t[n][i]?t[n][i]:0,o>t[n][i]?o:t[n][i]},h=function(){return o=(o=a[r])?o["min("+i+")"]:1/0,t[n][i]=t[n][i]?t[n][i]:1/0,o<t[n][i]?o:t[n][i]},f=function(){return o=(o=a[r])?o["sum("+i+")"]:0,o+=t[n][i]?t[n][i]:0},p=function(){var e=(o=a[r])?o["sum("+i+")"]:0;e+=t[n][i]?t[n][i]:0,t[n]["sum("+i+")"]=e,o=o?o["count("+i+")"]:0,o+=t[n][i]?1:0,t[n]["count("+i+")"]=o};for(var d in c){var y=c[d],v=T(y),m=void 0;switch(d){case s.Count:m=e;break;case s.Max:m=l;break;case s.Min:m=h;break;case s.Sum:m=f;break;case s.Avg:m=p}switch(v){case u.String:i=y,t[n][d+"("+i+")"]=m();break;case u.Array:for(var b in y)i=y[b],t[n][d+"("+i+")"]=m()}}};if(T(e)===u.String)for(n in t)r=t[n][e],l(),a[r]=t[n];else for(n in t){for(var h in r="",e)r+=t[n][e[h]];l(),a[r]=t[n]}for(var f in t=[],a)t.push(a[f]);if(c.avg)if(T(c.avg)===u.String)for(n in t){var p=t[n]["sum("+c.avg+")"],d=t[n]["count("+c.avg+")"];t[n]["avg("+c.avg+")"]=p/d,c.count!==c.avg&&delete t[n]["count("+c.avg+")"],c.sum!==c.avg&&delete t[n]["sum("+c.avg+")"]}else{var y=T(c.count)===u.String,v=T(c.sum)===u.String;for(n in t)for(var h in c.avg){var m=c.avg[h],b=t[n]["sum("+m+")"],g=t[n]["count("+m+")"];t[n]["avg("+m+")"]=b/g,y&&(c.count!==m||-1===c.count.indexOf(m))&&delete t[n]["count("+m+")"],v&&(c.sum!==m||-1===c.sum.indexOf(m))&&delete t[n]["sum("+m+")"]}}this.results=t},Ce.prototype.processGroupBy=function(){var e=this.query.groupBy,t=this.results,n={};if(this.results=this.query.groupBy=null,T(e)!==u.Object)if(T(e)===u.String)for(var r in t)n[t[r][e]]=t[r];else{var o=void 0;for(var r in t){for(var i in o="",e)o+=t[r][e[i]];n[o]=t[r]}}else if(1===Object.keys(e).length){var a=D(e);for(var r in this.thenEvaluator.setCaseAndColumn(e,a),t)n[this.thenEvaluator.setValue(t[r]).evaluate()]=t[r]}else for(var r in o=void 0,t){for(var i in o="",this.thenEvaluator.setCaseAndValue(e,t[r]),e)o+=this.thenEvaluator.setColumn(i).evaluate();n[o]=t[r]}for(var r in t=[],n)t.push(n[r]);this.results=t};var Oe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ie=function(e){function t(t,n){var r=e.call(this)||this;return r.resultCount=0,r.query=t,r.util=n,r.tableName=t.from,r}return Oe(t,e),t.prototype.execute=function(e){var t=this,n=new O(this.db),r=this.query,o=n.validate(i.Count,r);return o?x(o):e().then((function(e){var n;try{var o=function(){var e=new Ce(t.query,t.util);return e.isTxQuery=t.isTxQuery,e.execute().then((function(e){t.resultCount=e.length}))};t.initTransaction_(),n=null==r.join?null!=r.where?r.where.or||Q(t.query.where)?o():t.goToWhereLogic():t.executeWhereUndefinedLogic():o()}catch(e){t.onException(e)}return n.then((function(e){return t.resultCount}))}))},t.prototype.initTransaction_=function(){this.isTxQuery||this.util.createTransaction([this.query.from],c.ReadOnly),this.objectStore=this.util.objectStore(this.query.from)},t}(de);Ie.prototype.executeWhereUndefinedLogic=function(){var e,t,n=this,r=n.objectStore.count?(e=n.objectStore.count(),function(t){return function(){n.resultCount=e.result,t()}}):(e=n.objectStore.openCursor(),function(e){return function(r){(t=r.target.result)?(++n.resultCount,t.continue()):e()}});return p((function(t,n){e.onerror=n,e.onsuccess=r(t)}))},Ie.prototype.executeWhereLogic=function(e,t,n){var r,o,u=this;return t=n?t[n]:t,p((function(i,a){1===L(u.query.where)&&u.objectStore.count?(r=u.objectStore.index(e).count(u.util.keyRange(t,n))).onsuccess=function(){u.resultCount=r.result,i()}:(r=u.objectStore.index(e).openCursor(u.util.keyRange(t,n))).onsuccess=function(e){(o=e.target.result)?(u.whereCheckerInstance.check(o.value)&&++u.resultCount,o.continue()):i()},r.onerror=a}))},Ie.prototype.executeRegexLogic=function(e,t){var n,r=this,o=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&r.whereCheckerInstance.check(e.value)},p((function(e,t){o.onerror=t,o.onsuccess=function(t){(n=t.target.result)?(r.shouldAddValue(n)&&++r.resultCount,n.continue()):e()}}))},Ie.prototype.executeInLogic=function(e,t){var n,r=this,o=this.objectStore.index(e);return w(t.map((function(e){return t=e,u=r.util.keyRange(t),r.objectStore.count?p((function(e,t){var n=o.count(u);n.onsuccess=function(t){r.resultCount+=t.target.result,e()},n.onerror=t})):p((function(e,t){var i=o.openCursor(u);i.onsuccess=function(t){(n=t.target.result)?(r.whereCheckerInstance.check(n.value)&&++r.resultCount,n.continue()):e()},i.onerror=t}));var t,u})))};var je=function(e){return(Q(e)?e:e.split(".")).reduce((function(e,t){return e&&e[t]}),self)},Ae=function(e,t){var n=e.set,r=e.mapSet;if(r){var o=r(n,t);null!=o&&(n=o)}for(var i in n){var a=n[i];if(T(a)!==u.Object)t[i]=a;else for(var s in a){var c=a[s];switch(s){case"+":t[i]+=c;break;case"-":t[i]-=c;break;case"*":t[i]*=c;break;case"/":t[i]/=c;break;case"{push}":t[i].push(c);break;default:t[i]=a}break}}return t},Ne=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Re=function(e){function t(t,n){var o=e.call(this)||this;o.query=t,o.util=n,o.tableName=t.in;var i=t.mapSet;if(i){var a=T(i)===u.String?je(i):i;if(!a)throw new g(r.MethodNotExist,i);t.mapSet=a}return o}return Ne(t,e),t.prototype.execute=function(e){var t=this,n=this.query;try{var r=new O(this.db).validate(i.Update,n);return r?x(r):e().then((function(e){return t.initTransaction(),(null!=n.where?n.where.or||Q(n.where)?t.executeComplexLogic_():t.goToWhereLogic():t.executeWhereUndefinedLogic()).then((function(){return t.rowAffected}))}))}catch(e){return this.onException(e)}},t.prototype.executeComplexLogic_=function(){var e=this,t=this.query,n=new Ce({from:t.in,where:t.where,ignoreCase:t.ignoreCase},this.util);return n.isTxQuery=this.isTxQuery,n.execute().then((function(n){var r,o,u=e.primaryKey(t.in),i=[];n.forEach((function(e){i.push(e[u])})),n=null;var a=((r={})[u]=((o={})[s.In]=i,o),r);return e.query.where=a,e.initTransaction(),e.goToWhereLogic()}))},t.prototype.initTransaction=function(){var e=this.query.in;this.isTxQuery||this.util.createTransaction([e]),this.objectStore=this.util.objectStore(e)},t}(de);Re.prototype.executeWhereUndefinedLogic=function(){var e=this,t=this.objectStore.openCursor();return p((function(n,r){t.onsuccess=function(t){var o=t.target.result;if(o)try{var u=o.update(Ae(e.query,o.value));u.onsuccess=function(){++e.rowAffected,o.continue()},u.onerror=r}catch(e){r(e)}else n()},t.onerror=r}))},Re.prototype.executeWhereLogic=function(e,t,n){var r=this,o=this.query;t=n?t[n]:t;var u=this.objectStore.index(e).openCursor(this.util.keyRange(t,n));return p((function(e,t){u.onsuccess=function(n){var u=n.target.result;if(u)if(r.whereCheckerInstance.check(u.value))try{var i=u.update(Ae(o,u.value));i.onsuccess=function(){++r.rowAffected,u.continue()},i.onerror=t}catch(e){t(e)}else u.continue();else e()},u.onerror=t}))},Re.prototype.executeRegexLogic=function(e,t){var n,r=this,o=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&r.whereCheckerInstance.check(e.value)},p((function(e,t){o.onsuccess=function(o){if(n=o.target.result)if(r.shouldAddValue(n))try{var u=n.update(Ae(r.query,n.value));u.onsuccess=function(){++r.rowAffected,n.continue()},u.onerror=t}catch(e){t(e)}else n.continue();else e()},o.onerror=t}))},Re.prototype.executeInLogic=function(e,t){var n=this,r=this.objectStore.index(e),o=this.query;return w(t.map((function(e){return t=e,p((function(e,u){var i=r.openCursor(n.util.keyRange(t));i.onsuccess=function(t){var r=t.target.result;if(r){var i=r.value;if(n.whereCheckerInstance.check(i))try{var a=r.update(Ae(o,i));a.onsuccess=function(){++n.rowAffected,r.continue()},a.onerror=u}catch(e){u(e)}else r.continue()}else e()},i.onerror=u}));var t})))};var Qe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Le=function(){return(Le=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},De=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r}return Qe(t,e),t.prototype.execute=function(){var e,t,n=this,r=this.query,o=0,u={},i={},a=!0,s=r.queries,c=s.length;if(s.every((function(e,t){return!(t+1<c&&e.from!==s[t+1].from)||(a=!1,!1)})),a){var l=this.primaryKey(s[0].from);e=function(e){return e[l]}}else e=function(e){var t="";for(var n in e)t+=e[n];return t};return function a(){if(o<c)return(t=new Ce(s[o],n.util)).execute().then((function(t){return u={},t.forEach((function(t){var n=e(t);0===o?i[n]=t:null!=i[n]&&(u[n]=t)})),o>0&&(i=Le({},u)),++o,a()}));var l,h=[],f=void 0,p=r.skip,d=r.limit,y=!1,v=function(){h.push(u[l])},m=function(){h.length<d?v():y=!0},b=function(e){0===p?e():--p};if(f=r.skip&&r.limit?function(){b((function(){m()}))}:r.limit?m:r.skip?function(){b((function(){v()}))}:function(){v()},d){for(l in u)if(f(l),y)break}else for(l in u)f(l);return t.results=h,Object.assign(t.query,{order:r.order,join:{}}),t.processOrderBy(),t.processGroupDistinctAggr(),t.results}()},t}(E),Ve=function(){function e(){}return e.prototype.execute=function(e){return p((function(t,n){var o=indexedDB.deleteDatabase(e);o.onblocked=function(){var e=new g(r.DbBlocked);return n(k(e))},o.onerror=function(e){return n(k(e))},o.onsuccess=function(){t()}}))},e}(),We=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Be=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r}return We(t,e),t.prototype.execute=function(){var e,t=this,n=this.query,r=0,o={},u=!0,i=n.length;if(n.every((function(e,t){return!(t+1<i&&e.from!==n[t+1].from)||(u=!1,!1)})),u){var a=this.primaryKey(n[0].from);e=function(e){return e[a]}}else e=function(e){var t="";for(var n in e)t+=e[n];return t};return function u(){if(r<n.length)return new Ce(n[r++],t.util).execute().then((function(t){return t.forEach((function(t){o[e(t)]=t})),u()}));var i=[];for(var a in o)i.push(o[a]);return i}()},t}(E),Pe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Me=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r.tableName=t.from,r}return Pe(t,e),t.prototype.execute=function(e){var t,n=this,r=new O(this.db),o=this.query,u=r.validate(i.Remove,o);return u?x(u):e().then((function(e){try{n.initTransaction_(),t=null!=o.where?Q(o.where)?n.processWhereArrayQry():n.processWhere_():n.executeWhereUndefinedLogic()}catch(e){return n.onException(e)}return t.then((function(){return n.rowAffected}))}))},t.prototype.processWhereArrayQry=function(){var e=this,t=new Ce(this.query,this.util);return t.isTxQuery=this.isTxQuery,t.execute().then((function(t){var n,r,o=[],u=e.primaryKey(e.query.from);t.forEach((function(e){o.push(e[u])})),t=null;var i=((n={})[u]=((r={})[s.In]=o,r),n);return e.query[s.Where]=i,e.processWhere_()}))},t.prototype.processWhere_=function(){var e=this;return this.query.where.or&&this.processOrLogic(),this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))},t.prototype.initTransaction_=function(){this.isTxQuery||this.util.createTransaction([this.query.from]),this.objectStore=this.util.objectStore(this.query.from)},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQuerySuccess_=function(){var e=this,t=D(this._orInfo.OrQuery);if(null!=t){var n={};return n[t]=this._orInfo.OrQuery[t],delete this._orInfo.OrQuery[t],this.query.where=n,this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))}this.isOr=!0},t.prototype.processOrLogic=function(){this.isOr=!0;var e=this.query.where;this._orInfo={OrQuery:e.or},delete e.or},t}(de);Me.prototype.executeInLogic=function(e,t){var n=this,r=this.objectStore.index(e);return w(t.map((function(e){return t=e,p((function(e,o){var u=r.openCursor(n.util.keyRange(t));u.onsuccess=function(t){var r=t.target.result;r?(n.whereCheckerInstance.check(r.value)&&(r.delete(),++n.rowAffected),r.continue()):e()},u.onerror=o}));var t})))},Me.prototype.executeWhereUndefinedLogic=function(){var e,t=this,n=this.objectStore.openCursor();return p((function(r,o){n.onsuccess=function(n){(e=n.target.result)?(e.delete(),++t.rowAffected,e.continue()):r()},n.onerror=o}))},Me.prototype.executeWhereLogic=function(e,t,n){var r,o,u=this;return t=n?t[n]:t,o=this.objectStore.index(e).openCursor(this.util.keyRange(t,n)),p((function(e,t){o.onsuccess=function(t){(r=t.target.result)?(u.whereCheckerInstance.check(r.value)&&(r.delete(),++u.rowAffected),r.continue()):e()},o.onerror=t}))},Me.prototype.executeRegexLogic=function(e,t){var n,r=this,o=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&r.whereCheckerInstance.check(e.value)},p((function(e,t){o.onsuccess=function(t){(n=t.target.result)?(r.shouldAddValue(n)&&(n.delete(),++r.rowAffected),n.continue()):e()},o.onerror=t}))};var Ue=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ge=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r.tableName=t,r}return Ue(t,e),t.prototype.execute=function(e){var t=this,n=this.query;return this.isTxQuery||this.util.createTransaction([n,v.tableName]),e().then((function(e){var r=t.util.objectStore(n).clear();try{return p((function(e,o){r.onsuccess=function(r){var u=t.table(n);for(var i in u.autoIncColumnValue)u.autoIncColumnValue[i]=0;v.set(v.dbSchema,t.util.db,t.util).then((function(){e()})).catch(o)},r.onerror=o}))}catch(e){return t.onException(e)}}))},t}(E),Fe=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ke=function(e){function t(t,n){var r=e.call(this)||this;return r.results={},r.reqQueue=[],r.isQueryExecuting=!1,r.isTxStarted_=!1,r.query=t,r.util=n,r}return Fe(t,e),t.prototype.execute=function(e){var t=this;this.beforeExecute=e;var n=this.validate();return n?x(n):(this.startExecution_(),p((function(e,n){t.onSuccess=e,t.onError=n})).then((function(e){return t.beforeExecute=null,t.log("transaction finished"),e})))},t.prototype.validate=function(){var e=this.query,t=this.notExistingTable_(e.tables);if(t)return new g(r.TableNotExist,{tableName:t});var n=e.method;return je(n)?void 0:new g(r.MethodNotExist,n)},t.prototype.startExecution_=function(){var e=this,t=this.query,n=t.method,r=je(n);return this.log("transaction query started"),r.call(this,{data:t.data,insert:function(t){return e.pushReq_({name:i.Insert,query:t})},select:function(t){return e.pushReq_({name:i.Select,query:t})},update:function(t){return e.pushReq_({name:i.Update,query:t})},remove:function(t){return e.pushReq_({name:i.Remove,query:t})},count:function(t){return e.pushReq_({name:i.Count,query:t})},setResult:function(t,n){e.results[t]=n},getResult:function(t){return e.results[t]},abort:function(t){e.abortTx_(t)},start:function(){e.startTx_()}})},t.prototype.log=function(e){this.util.logger.log(e)},t.prototype.startTx_=function(){var e=this;try{this.isTxStarted_=!0;var t=this.query.tables;return t=t.concat(v.tableName),this.util.createTransaction(t).then((function(t){e.onSuccess(e.results)})).catch((function(t){e.onError(t)})),this.processExecutionOfQry_()}catch(e){this.onError(this.onException(e))}},t.prototype.onReqFinished_=function(e){var t=this.reqQueue.shift();this.log("finished request : "+t.name+" "),t&&(e.error?(this.abortTx_("automatic abort of transaction due to error occured"),this.log("transaction aborted due to error occured"),this.onError(e.error)):(this.isQueryExecuting=!1,t.onSuccess&&t.onSuccess(e),this.processExecutionOfQry_()))},t.prototype.abortTx_=function(e){this.reqQueue=[],this.util.abortTransaction(),this.log("transaction aborted. Msg : "+e)},t.prototype.executeRequest_=function(e){var t;this.isQueryExecuting=!0,this.log("executing request : "+e.name+" ");var n=this.onReqFinished_.bind(this),r=e.query;switch(e.name){case i.Select:t=new Ce(r,this.util);break;case i.Insert:t=new j(r,this.util);break;case i.Update:t=new Re(r,this.util);break;case i.Remove:t=new Me(r,this.util);break;case i.Count:t=new Ie(r,this.util)}t.isTxQuery=!0,t.execute(this.beforeExecute).then(n).catch((function(e){n({error:e})}))},t.prototype.pushReq_=function(e){var t=this,n=function(){t.reqQueue.push(e)},r=p((function(t,n){e.onSuccess=function(e){t(e)},e.onError=function(e){n(e)}}));return!0===this.isTxStarted_?(n(),this.processExecutionOfQry_()):n(),this.log("request pushed : "+e.name),r},t.prototype.processExecutionOfQry_=function(){!1===this.isQueryExecuting&&this.reqQueue.length>0&&this.executeRequest_(this.reqQueue[0])},t.prototype.notExistingTable_=function(e){var t=this,n=null;return e.every((function(e){return null!=t.table(e)||(n=e,!1)})),n},t}(E),Je=function(e){var t={name:e.name,version:e.version,tables:[]};return e.tables.forEach((function(e){var n={name:e.name,columns:{}};e.columns.forEach((function(e){n.columns[e.name]=e})),t.tables.push(n)})),t},ze=function(){function e(e){this.middlewares=[],this.util=new _,this.onQryFinished=A?function(e){self.postMessage(e)}:e}return Object.defineProperty(e.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"logger",{get:function(){return this.util.logger},enumerable:!1,configurable:!0}),e.prototype.executeMiddleware_=function(e){var t=this,n=L(this.middlewares)-1;if(n<0)return f();var r={},o=this.db;return Object.defineProperty(r,"database",{get:function(){return Je(o)}}),p((function(o){var u=0;!function i(){if(u<=n){var a=je(t.middlewares[u++])(e,r);a&&a.then||(a=Promise.resolve(a)),a.then((function(e){i()}))}else o()}()}))},e.prototype.executeQuery=function(e,t){var n,o=e.query;switch(e.name){case i.OpenDb:t(),n=this.openDb(o);break;case i.InitDb:t(),n=this.initDb(o);break;case i.CloseDb:t(),n=this.closeDb();break;case i.Insert:n=new j(o,this.util).execute(t);break;case i.Select:n=new Ce(o,this.util).execute(t);break;case i.Count:n=new Ie(o,this.util).execute(t);break;case i.Update:n=new Re(o,this.util).execute(t);break;case i.Intersect:t(),n=new De(o,this.util).execute();break;case i.DropDb:t(),n=this.dropDb();break;case i.Terminate:t(),n=this.terminate();break;case i.Union:t(),n=new Be(o,this.util).execute();break;case i.Remove:n=new Me(o,this.util).execute(t);break;case i.Clear:n=new Ge(o,this.util).execute(t);break;case i.Transaction:n=new Ke(o,this.util).execute(t);break;case i.Get:t(),n=v.get(o,this.util);break;case i.Set:t(),n=v.set(o.key,o.value,this.util);break;case i.ImportScripts:t(),n=this.importScripts_(e);break;case i.ChangeLogStatus:t(),this.logger.status=o,n=Promise.resolve();break;case i.Middleware:return t(),je(o)?(this.middlewares.push(o),f()):x(new g(r.InvalidMiddleware,o));default:n=f()}return this.logger.log("Executing query "+e.name+" in web worker"),n},e.prototype.callResultMiddleware=function(e,t){return p((function(n){var r=0,o=L(e)-1;!function u(){if(r<=o){var i=e[r++](t);i instanceof Promise||(i=f(i)),i.then((function(e){t=e,u()}))}else n(t)}()}))},e.prototype.callBeforeMiddleware=function(e){return p((function(t){var n=0,r=L(e)-1;!function o(){if(n<=r){var u=e[n++]();u instanceof Promise||(u=f(u)),u.then(o)}else t()}()}))},e.prototype.run=function(e){var t=this,n=[],r=[];e.onResult=function(e){n.push((function(t){return e(t)}))},e.beforeExecute=function(e){r.push((function(t){return e(t)}))},this.executeMiddleware_(e).then((function(o){return t.executeQuery(e,(function(){return t.callBeforeMiddleware(r)})).then((function(e){return t.callResultMiddleware(n,e).then((function(e){t.returnResult_({result:e})}))}))})).catch((function(e){n=[];var r={error:k(e)};t.returnResult_(r)}))},e.prototype.importScripts_=function(e){return p((function(t,n){try{importScripts.apply(void 0,e.query),t()}catch(e){n(new g(r.ImportScriptsFailed,e.message))}}))},e.prototype.returnResult_=function(e){this.logger.log("Query finished inside web worker"),this.util&&this.util.emptyTx(),this.onQryFinished(e)},e.prototype.dropDb=function(){var e=this.db.name;return this.terminate().then((function(){return(new Ve).execute(e)}))},e.prototype.closeDb=function(){return this.util.close()},e.prototype.terminate=function(){var e=this;return this.closeDb().then((function(){e.util.db=null}))},e.prototype.openDb=function(e){var t=this;return this.closeDb().then((function(n){return(t.db&&e.name===t.db.name?t.initDb():t.initDb({name:e.name,tables:[],version:e.version})).then((function(){return t.db}))}))},e.prototype.initDb=function(e){var t=this;if(!N)return x(new g(r.IndexedDbNotSupported));var n=e?new m(e):this.db;return this.util=new _,p((function(e,r){t.util.initDb(n).then((function(r){r.isCreated?v.get(v.dbSchema,t.util).then((function(o){o&&o.tables.forEach((function(e,t){var r=n.tables[t];r&&(r.autoIncColumnValue=e.autoIncColumnValue)})),t.util.db=n,r.database=Je(t.db),v.set(v.dbSchema,n,t.util).then((function(){e(r)}))})):v.get(v.dbSchema,t.util).then((function(n){t.util.db=n,r.database=Je(t.db),e(r)}))})).catch(r)}))},e}();if(A){var $e=new ze;self.onmessage=function(e){$e.run(e.data)}}}});